# Creating a release

The preferred way to create a release is to use the `Create Release` workflow, provided by GitHub
Actions (GitHub's continuous integration system), since it automates most of the process. If GitHub
Actions are not available, you can also create a release manually.

Both methods are described below.

## Common steps

Some steps are common to both methods, so make sure to follow them before proceeding with either
method.

1. Make sure all changes are committed to the `main` branch and pushed to the remote repository.
2. Make sure the [CHANGELOG.md](../../CHANGELOG.md) is up to date. All new changes since the last
   release should be listed in the `[Unreleased]` section. See the
   [guidelines docs](https://github.com/IRNAS/irnas-guidelines-docs/blob/main/docs/github_projects_guidelines.md#changelog-)
   on how the CHANGELOG hold be structured.

## Using the `Create Release` GitHub action

1. Go to the `Actions` tab of the repository on GitHub and Run the `Create Release` workflow.
   Details with images can be found in the [Workflows Template] documentation.
2. The action requires a version number to be provided: `vX.Y.Z`. Make sure to use a version above
   the last release and follow the [Versioning Guidelines].

The CI will then automatically create a git tag, update the `CHANGELOG.md` file and build release
artifacts. If build process is successful, it will then create a new GitHub release with the latest
`CHANGELOG.md` entry pasted in as release notes and upload release artifacts to it.

## Manually creating a release

1. Checkout the `main` branch of the repository: `git checkout main`.
2. Determine what the new release version will be. It should be higher than the last release version
   and follow the [Versioning Guidelines].
3. Update the `CHANGELOG.md` file:
   - Move the `[Unreleased]` section to a new section with the version number and todays date, e.g.
     `## [vX.Y.Z] - YEAR-MONTH-DAY`.
   - Add a new `[Unreleased]` section at the top.
   - Update the links on the bottom of the file to add new compare links for the new version. See
     the [keepachangelog] docs for an example.
4. Commit the changes to the `main` branch with a commit message
   `docs: Update CHANGELOG.md for release vX.Y.Z`.
5. Push the changes to the remote repository: `git push`.
6. Create a new git tag with the version number: `git tag vX.Y.Z`.
7. Push the tag to the remote repository: `git push origin tag vX.Y.Z`.
8. Checkout the tag: `git checkout vX.Y.Z`.
9. Build the release artifacts:
   1. `cd` to the root of the repository.
   2. `make pre-build`
   3. `make release`
   4. `make pre-package`
   5. Make sure all artifacts to be released are in the `artifacts` directory.
10. Create a new release on GitHub:
    1. Go to the `Releases` tab of the repository on GitHub.
    2. Click on `Draft a new release`.
    3. Select the tag you just created from the dropdown.
    4. Fill in the release title and description:
       - Title: `Release vX.Y.Z`
       - Description - copy the content from the `CHANGELOG.md` and add any other relevant text.
    5. Upload the release artifacts from the `artifacts` directory.
    6. Click on `Publish release`.

## Release configuration

This section describes how to configure what is included in the release artifacts.

First, check the `Makefile` in the root of the repository. The following commands are used to create
a release:

- `make pre-build` - prepares the build.
- `make release` - builds the firmware and other artifacts.
- `make pre-package` - prepares the artifacts for packaging.

After these commands are run, all artifacts that will appear on the release page should be in the
`artifacts` directory.

The artifacts are split into two categories:

- Generated by twister - this are all the firmware applications and samples.
- Generated by other means.

### Twister generated artifacts

To build the firmware applications and samples for various boards and build configurations, the
`twister` test runner is used. We leverage its tagging option to select which applications and
samples to build for the release. See [Filtering by Tags](./twister.md#filtering-by-tags) for more
details.

There are 3 steps to add a new firmware application or sample to the release:

- Make twiser aware of it so that it is built. This is done in `sample.yml` files.
- Select which specific files from the build will be packaged by `east pack`. This is done in
  `east.yml`.
- Make sure a `VERSION` file is generated for the application or sample if it requires it.

#### Twister configuration

To add a new application or sample to the release, modify its `sample.yml` file and add the
`release` tag to it. The tag can be placed under `common`, which means all configurations will
released, or under a specific configuration, which means only that configuration will be released.

The `make release` command is already configured to build all applications and samples with the
`release` tag, so no further configuration is needed.

#### `east.yml` configuration

To select which files from the build will be included in the release, modify the `east.yml` file in
the root of the repository.

1. If what is already set in `pack.artifacts` is sufficient, no changes are needed.
2. If you want to add an additional file or override `pack.artifacts` for the new application or
   sample, do the following:
   - Add a new entry under `pack.build_configurations` with:
   - `name` - the name of the application or sample (must match the name in the `sample.yml` file).
   - `artifacts` - a list of files to include in the release in addition to the default ones.
   - `overwrite_artifacts` - a list of files to include in the release instead of the default ones.

See the [east documentation] for more details on the `east.yml` file and its structure.

#### VERSION file generation

If the new application or sample requires a `VERSION` file (e.g. it uses MCUBoot), modify `east.yml`
to include the path to the new application or sample under `version.paths`. This will ensure that
the `VERSION` file is generated when `make pre-package` is run.

<!-- prettier-ignore -->
> [!NOTE]
> `east util version` is run as a part of make pre-package.
> Run it with the `--help` flag to learn how to use it.

### Other artifacts

Other artifacts are generated by the `make release` command and are not related to twister.

To add a new artifact to the release, do the following:

1. In the `Makefile`, modify `release` so that the new file(s) are generated by whatever process
   they require. If you wish to add a directory, create a zip archive of it.
2. Modify `east.yml` to make east pack aware of the new artifact. Add a new entry under `pack.extra`
   with the path to the file.

[Workflows Template]:
  https://github.com/IRNAS/irnas-workflows-software/tree/main/workflow-templates/basic#how-to-use
[Versioning guidelines]:
  https://github.com/IRNAS/irnas-guidelines-docs/blob/main/docs/github_projects_guidelines.md#versioning-1%EF%B8%8F%E2%83%A30%EF%B8%8F%E2%83%A30%EF%B8%8F%E2%83%A3
[keepachangelog]: https://keepachangelog.com/en/1.0.0/
[east documentation]: https://github.com/IRNAS/irnas-east-software/?tab=readme-ov-file#documentation
